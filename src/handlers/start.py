from aiogram import Router, F
from aiogram.filters import CommandStart, Command # –î–æ–±–∞–≤–ª–µ–Ω Command
from aiogram.types import Message
from sqlalchemy import select
from src.models import User
from src.services.wallet_service import wallet_service
from src.config import settings
from src.utils.keyboards import get_main_menu_keyboard, get_games_keyboard
from src.i18n.translator import translator

router = Router()


@router.message(CommandStart())
async def cmd_start(message: Message):
    """–ö–æ–º–∞–Ω–¥–∞ /start"""
    from src.database import async_session_maker
    
    telegram_id = message.from_user.id
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø —á–∞—Ç–∞
    if message.chat.type in ['group', 'supergroup']:
        # –í –≥—Ä—É–ø–ø–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç, –±–µ–∑ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
        await message.answer(
           "üé∞ <b>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ HightRoll Casino!</b>\n\n"
           "–ü–æ–≥–Ω–∞–ª–∏ –∫—Ä—É—Ç–∏—Ç—å –±–∞—Ä–∞–±–∞–Ω—ã!\n\n"
           "üí° –ò—Å–ø–æ–ª—å–∑—É–π <code>/help</code> —á—Ç–æ–±—ã —É–∑–Ω–∞—Ç—å –≤—Å–µ –∫–æ–º–∞–Ω–¥—ã."
        )
        return # –ó–∞–≤–µ—Ä—à–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É, –Ω–µ –≤—ã–ø–æ–ª–Ω—è—è –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ —Ñ—É–Ω–∫—Ü–∏–∏

    async with async_session_maker() as session:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        result = await session.execute(
            select(User).where(User.telegram_id == telegram_id)
        )
        user = result.scalar_one_or_none()
        
        # –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
        if not user:
            user = User(
                telegram_id=telegram_id,
                username=message.from_user.username,
                first_name=message.from_user.first_name,
                last_name=message.from_user.last_name,
                language_code=message.from_user.language_code or 'en',
                personality='playful' # –ù–û–í–û–ï: –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            )
            session.add(user)
            await session.commit()
            await session.refresh(user)
            
            # –°–æ–∑–¥–∞—ë–º –∫–æ—à–µ–ª—ë–∫ –∏ –Ω–∞—á–∏—Å–ª—è–µ–º —Å—Ç–∞—Ä—Ç–æ–≤—ã–π –±–æ–Ω—É—Å
            await wallet_service.credit(
                user.id,
                settings.STARTER_BONUS,
                'starter_bonus'
            )
            
            user.received_starter_bonus = True
            await session.commit()
            
            # –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
            text = translator.get(
                'welcome.first_time',
                user.language_code,
                balance=f"${settings.STARTER_BONUS / 100:.0f}"
            )
        else:
            # –°—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
            balance = await wallet_service.get_balance(user.id)
            text = translator.get(
                'welcome.returning',
                user.language_code,
                name=user.first_name,
                balance=f"${balance / 100:.2f}"
            )
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –¢–û–õ–¨–ö–û –≤ –ª–∏—á–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö
    await message.answer(
        text,
        reply_markup=get_main_menu_keyboard()
    )

@router.message(Command('help'))
async def cmd_help(message: Message):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /help"""
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø —á–∞—Ç–∞
    if message.chat.type in ['group', 'supergroup']:
        help_text = (
            "üé∞ <b>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ HightRoll!</b>\n\n"
            "–≠—Ç–æ—Ç –±–æ—Ç –ø–æ–∑–≤–æ–ª—è–µ—Ç –∏–≥—Ä–∞—Ç—å –≤ –∞–∑–∞—Ä—Ç–Ω—ã–µ –∏–≥—Ä—ã, –∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –∏ —Ç—Ä–∞—Ç–∏—Ç—å –≤–∏—Ä—Ç—É–∞–ª—å–Ω—É—é –≤–∞–ª—é—Ç—É üí∞, "
            "–ø—Ä–æ–∫–∞—á–∏–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å –∏ –ø–æ–ª—É—á–∞—Ç—å –±–æ–Ω—É—Å—ã –∫–∞–∂–¥—ã–π –¥–µ–Ω—å!\n\n"
            
                   "<b>üìå –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:</b>\n"
                   "‚Ä¢ /start - –ù–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É —Å –±–æ—Ç–æ–º üéÅ\n"
                   "‚Ä¢ /help - –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ\n"
                   "‚Ä¢ /balance - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –±–∞–ª–∞–Ω—Å –º–æ–Ω–µ—Ç üíé\n"
                   "‚Ä¢ /profile - –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø—Ä–æ—Ñ–∏–ª—å, —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è üèÜ\n"
                   "‚Ä¢ /bonus - –ü–æ–ª—É—á–∏—Ç—å –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–π –±–æ–Ω—É—Å üéâ\n"
                   "‚Ä¢ /buy - –ö—É–ø–∏—Ç—å –º–æ–Ω–µ—Ç—ã —á–µ—Ä–µ–∑ Telegram Stars üí≥\n"
                   "‚Ä¢ /settings - –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ ‚öôÔ∏è\n\n"

                   "<b>üéÆ –î–æ—Å—Ç—É–ø–Ω—ã–µ –∏–≥—Ä—ã:</b>\n"
                   "‚Ä¢ /slots - –ò–≥—Ä–æ–≤—ã–µ —Å–ª–æ—Ç—ã —Å —à–∞–Ω—Å–æ–º –≤—ã–∏–≥—Ä–∞—Ç—å –º–æ–Ω–µ—Ç—ã üé∞\n"
                   "‚Ä¢ /dice - –ö–æ—Å—Ç–∏: —É–≥–∞–¥–∞–π —á–∏—Å–ª–æ –∏ –≤—ã–∏–≥—Ä–∞–π üé≤\n"
                   "‚Ä¢ /roulette - –†—É–ª–µ—Ç–∫–∞: —Å—Ç–∞–≤—å –Ω–∞ —Ü–≤–µ—Ç, —á–∏—Å–ª–æ –∏–ª–∏ –¥–∏–∞–ø–∞–∑–æ–Ω üé°\n"
                   "‚Ä¢ /mines - –ú–∏–Ω—ã: –æ—Ç–∫—Ä–æ–π –∫–ª–µ—Ç–∫–∏ –∏ –∏–∑–±–µ–≥–∞–π –±–æ–º–± üí£\n\n"
            
                   "<b>üí° –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ –≥—Ä—É–ø–ø–∞—Ö:</b>\n"
                   "‚Ä¢ <code>/dice 50</code> - –∏–≥—Ä–∞ –≤ –∫–æ—Å—Ç–∏ —Å–æ —Å—Ç–∞–≤–∫–æ–π $50\n"
                   "‚Ä¢ <code>/slots 25</code> - –∏–≥—Ä–∞ –≤ —Å–ª–æ—Ç—ã —Å–æ —Å—Ç–∞–≤–∫–æ–π $25\n"
                   "‚Ä¢ <code>/roulette 100</code> - –∏–≥—Ä–∞ –≤ —Ä—É–ª–µ—Ç–∫—É —Å–æ —Å—Ç–∞–≤–∫–æ–π $100\n"
                   "‚Ä¢ <code>/mines 200</code> - –∏–≥—Ä–∞ –≤ –º–∏–Ω—ã —Å–æ —Å—Ç–∞–≤–∫–æ–π $200\n\n"
            
            "<b>‚≠ê –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –±–æ—Ç–∞:</b>\n"
            "‚Ä¢ –í–∏—Ä—Ç—É–∞–ª—å–Ω–∞—è –≤–∞–ª—é—Ç–∞ ‚Äî –º–æ–Ω–µ—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–∂–Ω–æ –∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –∏ —Ç—Ä–∞—Ç–∏—Ç—å üí∞\n"
            "‚Ä¢ –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–µ –±–æ–Ω—É—Å—ã –¥–ª—è –∞–∫—Ç–∏–≤–Ω—ã—Ö –∏–≥—Ä–æ–∫–æ–≤ üéÅ\n"
            "‚Ä¢ –ü—Ä–æ–∫–∞—á–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è –∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ–±–µ–¥ –∏ –ø—Ä–æ–∏–≥—Ä—ã—à–µ–π üìä\n\n"
            
            "–ò—Å–ø–æ–ª—å–∑—É–π –∫–æ–º–∞–Ω–¥—ã —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ –≤ –≥—Ä—É–ø–ø–∞—Ö –∏–ª–∏ –ø–æ–ª–Ω–æ–µ –º–µ–Ω—é –≤ –ª–∏—á–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö! üíé"
        )
        await message.answer(help_text)
        return

    help_text = (
    "üé∞ <b>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ HightRoll!</b>\n\n"
    "–≠—Ç–æ—Ç –±–æ—Ç –ø–æ–∑–≤–æ–ª—è–µ—Ç –∏–≥—Ä–∞—Ç—å –≤ –∞–∑–∞—Ä—Ç–Ω—ã–µ –∏–≥—Ä—ã, –∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –∏ —Ç—Ä–∞—Ç–∏—Ç—å –≤–∏—Ä—Ç—É–∞–ª—å–Ω—É—é –≤–∞–ª—é—Ç—É üí∞, "
    "–ø—Ä–æ–∫–∞—á–∏–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å –∏ –ø–æ–ª—É—á–∞—Ç—å –±–æ–Ω—É—Å—ã –∫–∞–∂–¥—ã–π –¥–µ–Ω—å!\n\n"
    "<b></b>\n"
    
    "<b>üìå –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:</b>\n"
    "‚Ä¢ /start - –ù–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É —Å –±–æ—Ç–æ–º üéÅ\n"
    "‚Ä¢ /help - –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ\n"
    "‚Ä¢ /balance - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –±–∞–ª–∞–Ω—Å –º–æ–Ω–µ—Ç üíé\n"
    "‚Ä¢ /profile - –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø—Ä–æ—Ñ–∏–ª—å, —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è üèÜ\n"
    "‚Ä¢ /bonus - –ü–æ–ª—É—á–∏—Ç—å –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–π –±–æ–Ω—É—Å üéâ\n"
    "‚Ä¢ /buy - –ö—É–ø–∏—Ç—å –º–æ–Ω–µ—Ç—ã —á–µ—Ä–µ–∑ Telegram Stars üí≥\n"
    "‚Ä¢ /settings - –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ ‚öôÔ∏è\n" # –ù–û–í–û–ï

    "<b></b>\n"

    "<b>üéÆ –î–æ—Å—Ç—É–ø–Ω—ã–µ –∏–≥—Ä—ã:</b>\n"
    "‚Ä¢ /slots - –ò–≥—Ä–æ–≤—ã–µ —Å–ª–æ—Ç—ã —Å —à–∞–Ω—Å–æ–º –≤—ã–∏–≥—Ä–∞—Ç—å –º–æ–Ω–µ—Ç—ã üé∞\n"
    "‚Ä¢ /dice - –ö–æ—Å—Ç–∏: —É–≥–∞–¥–∞–π —á–∏—Å–ª–æ –∏ –≤—ã–∏–≥—Ä–∞–π üé≤\n"
    "‚Ä¢ /roulette - –†—É–ª–µ—Ç–∫–∞: —Å—Ç–∞–≤—å –Ω–∞ —Ü–≤–µ—Ç, —á–∏—Å–ª–æ –∏–ª–∏ –¥–∏–∞–ø–∞–∑–æ–Ω üé°\n"
    "‚Ä¢ /mines - –ú–∏–Ω—ã: –æ—Ç–∫—Ä–æ–π –∫–ª–µ—Ç–∫–∏ –∏ –∏–∑–±–µ–≥–∞–π –±–æ–º–± üí£\n"
    
    "<b></b>\n"

    "<b>‚≠ê –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –±–æ—Ç–∞:</b>\n"
    "‚Ä¢ –í–∏—Ä—Ç—É–∞–ª—å–Ω–∞—è –≤–∞–ª—é—Ç–∞ ‚Äî –º–æ–Ω–µ—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–∂–Ω–æ –∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –∏ —Ç—Ä–∞—Ç–∏—Ç—å üí∞\n"
    "‚Ä¢ –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–µ –±–æ–Ω—É—Å—ã –¥–ª—è –∞–∫—Ç–∏–≤–Ω—ã—Ö –∏–≥—Ä–æ–∫–æ–≤ üéÅ\n"
    "‚Ä¢ –ü—Ä–æ–∫–∞—á–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è –∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ–±–µ–¥ –∏ –ø—Ä–æ–∏–≥—Ä—ã—à–µ–π üìä\n"
    
    "<b></b>\n"

    "–ò—Å–ø–æ–ª—å–∑—É–π –∫–Ω–æ–ø–∫–∏ –≤ –º–µ–Ω—é –≤ –ª–∏—á–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö –∏–ª–∏ –≤–≤–æ–¥–∏ –∫–æ–º–∞–Ω–¥—ã –≤—Ä—É—á–Ω—É—é, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –∏–≥—Ä–∞—Ç—å –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å! üíé"
    )
    await message.answer(help_text)


# --- –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –ö–ù–û–ü–û–ö –ú–ï–ù–Æ ---

@router.message(F.text == "üéÆ –ò–≥—Ä—ã")
async def show_games_menu(message: Message):
    """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –º–µ–Ω—é –∏–≥—Ä"""
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø —á–∞—Ç–∞ - —Ç–æ–ª—å–∫–æ –¥–ª—è –ª–∏—á–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
    if message.chat.type in ['group', 'supergroup']:
        return
    
    await message.answer(
        "üéÆ <b>–í—ã–±–µ—Ä–∏—Ç–µ –∏–≥—Ä—É:</b>\n\n"
        "üé∞ <b>–°–ª–æ—Ç—ã</b> - –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–µ –∏–≥—Ä–æ–≤—ã–µ –∞–≤—Ç–æ–º–∞—Ç—ã\n"
        "üé≤ <b>–ö–æ—Å—Ç–∏</b> - –¥—É—ç–ª—å —Å –±–æ—Ç–æ–º –Ω–∞ —É–¥–∞—á—É\n"
        "‚ô†Ô∏è <b>–†—É–ª–µ—Ç–∫–∞</b> - —Å—Ç–∞–≤–∫–∏ –Ω–∞ —Ü–≤–µ—Ç –∏ —á–∏—Å–ª–∞\n"
        "üí£ <b>–ú–∏–Ω—ã</b> - –æ—Ç–∫—Ä–æ–π –∫–ª–µ—Ç–∫–∏ –∏ –∏–∑–±–µ–≥–∞–π –±–æ–º–±\n"
        "üöÄ <b>–†–∞–∫–µ—Ç–∫–∞</b> - —Ä–∞—Å—Ç—É—â–∏–π –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –¥–æ –≤–∑—Ä—ã–≤–∞",
        reply_markup=get_games_keyboard()
    )


@router.message(F.text == "üîô –ù–∞–∑–∞–¥")
async def back_to_main_menu(message: Message):
    """–í–æ–∑–≤—Ä–∞—Ç –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é"""
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø —á–∞—Ç–∞ - —Ç–æ–ª—å–∫–æ –¥–ª—è –ª–∏—á–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
    if message.chat.type in ['group', 'supergroup']:
        return
    
    await message.answer(
        "üè† <b>–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</b>\n\n"
        "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:",
        reply_markup=get_main_menu_keyboard()
    )
